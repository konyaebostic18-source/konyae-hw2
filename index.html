<!DOCTYPE html>
<html>
<head>
<title>End Of The World</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
</head>
<body style="margin:0;padding:0;overflow:hidden;">

<script>
let p;
let zombies = [];
let bullets = [];

// images
let playerImg, shootImg, bulletImg;
let zombieImg, bigZombieImg, fastZombieImg;

// shoot animation
let shootMode = false;

// ammo
let ammo = 6;
let maxAmmo = 6;
let reloading = false;
let reloadTime = 1000;
let reloadStart;

// screen flash
let flash = false;
let flashTimer = 0;
let flashDuration = 30;

// difficulty
let spawnRate = 120;
let fastestSpawnRate = 60;
let nextScoreMilestone = 4000;

// score + font
let score = 0;
let font;

// start
let gameStarted = false;

// player health/game over
let pHealth = 3;
let gameOver = false;
let gameOverSoundPlayed = false;

// audio
let music, gunshot, reload, over;

function preload() {
  playerImg = loadImage("player.png");
  shootImg = loadImage("shoot.png");
  bulletImg = loadImage("bullet.png");

  zombieImg = loadImage("zombie.png");
  bigZombieImg = loadImage("big.png");
  fastZombieImg = loadImage("fast.png");

  zombieImg.resize(260,180);
  bigZombieImg.resize(280,200);
  fastZombieImg.resize(180,100);

  music = loadSound("gameMusic.mp3");
  gunshot = loadSound("shotgunSound.wav");
  reload = loadSound("reloadSound.wav");
  over = loadSound("over.wav");

  font = loadFont("orbitronRegular.ttf");
}

function setup() {
  createCanvas(550,450);
  textFont(font);
  p = new Player();
  music.loop();
}

function draw() {
  background(0);

  if (!gameStarted) {
    startScreen();
    return;
  }

  fill(255);
  textAlign(LEFT,TOP);
  text("Score: " + score,5,5);
  text("Ammo: " + ammo + (reloading ? " (Reloading...)" : ""),5,420);
  text("Health: " + pHealth,5,25);

  if (gameOver) {
    if (music.isPlaying()) music.pause();
    if (!gameOverSoundPlayed) {
      over.play();
      gameOverSoundPlayed = true;
    }
    gameOverScreen();
    return;
  }

  // reload
  if (reloading && millis() - reloadStart >= reloadTime) {
    ammo = maxAmmo;
    reloading = false;
  }

  if (ammo === 0) {
    fill(255,0,0);
    textAlign(CENTER,CENTER);
    text("R to Reload", width/2, height/2);
  }

  // flash
  if (flash) {
    flashTimer++;
    strokeWeight(30);
    stroke(255,0,0,200);
    noFill();
    rect(width/2,height/2,width,height);
    if (flashTimer >= flashDuration) flash = false, flashTimer = 0;
  }

  // spawn zombies
  if (frameCount % spawnRate === 0) {
    zombies.push(new Zombie());
    if (score >= nextScoreMilestone) {
      spawnRate = max(fastestSpawnRate, spawnRate-30);
      nextScoreMilestone += 4000;
    }
  }

  // update zombies
  for (let i = zombies.length-1; i >= 0; i--) {
    let z = zombies[i];
    z.update();
    z.display();

    if (z.isDead()) {
      score += z.scoreValue();
      zombies.splice(i,1);
    } else if (z.y > height) {
      zombies.splice(i,1);
      flash = true;
      pHealth--;
      if (pHealth <= 0) gameOver = true;
    }
  }

  // player
  p.display();

  // bullets
  for (let i = bullets.length-1; i >= 0; i--) {
    let b = bullets[i];
    b.update();
    b.display();
    if (b.y < 0) bullets.splice(i,1);
  }

  // bullet hit detection
  for (let i = bullets.length-1; i >= 0; i--) {
    let b = bullets[i];
    let hit = false;

    for (let j = zombies.length-1; j >= 0; j--) {
      let z = zombies[j];
      if (abs(b.x - z.x) < 30 && abs(b.y - z.y) < 30) {
        z.takeDamage();
        hit = true;
        if (z.isDead()) {
          score += z.scoreValue();
          zombies.splice(j,1);
        }
        break;
      }
    }

    if (hit) bullets.splice(i,1);
  }
}

function startScreen() {
  fill(255,0,0);
  textAlign(CENTER,CENTER);
  textSize(40);
  text("END OF THE WORLD", width/2, height/2-80);

  fill(255);
  textSize(18);
  text("Controls:", width/2, height/2-20);
  text("←/→ Move", width/2, height/2+10);
  text("SPACE = Shoot", width/2, height/2+40);
  text("R = Reload", width/2, height/2+70);

  textSize(20);
  text("Press ENTER to Start", width/2, height/2+130);
}

function gameOverScreen() {
  textAlign(CENTER,CENTER);
  fill(255,0,0);
  textSize(40);
  text("GAME OVER", width/2, height/2-20);
  fill(255);
  textSize(20);
  text("Press R to Restart", width/2, height/2+30);
}

// ===== CLASSES =====
class Player {
  constructor() {
    this.x = width/2;
    this.y = height-60;
  }
  moveLeft() { this.x = max(40, this.x-10); }
  moveRight() { this.x = min(width-40, this.x+10); }
  display() { image(shootMode ? shootImg : playerImg, this.x-40, this.y-40,80,80); }
}

class Zombie {
  constructor() {
    this.y = 0;
    this.slot = floor(random(0,5));
    this.x = width/5 * this.slot + width/10;
    let r = random(1);
    if (r < 0.6) { this.type="normal"; this.hp=2; this.speed=2; this.img=zombieImg; }
    else if (r < 0.85) { this.type="big"; this.hp=4; this.speed=1; this.img=bigZombieImg; }
    else { this.type="fast"; this.hp=1; this.speed=4; this.img=fastZombieImg; }
  }
  update() { this.y += this.speed; }
  display() { image(this.img, this.x-60, this.y-40); }
  takeDamage() { this.hp--; }
  isDead() { return this.hp <= 0; }
  scoreValue() { return this.type=="normal"?100:this.type=="big"?200:150; }
}

class Bullet {
  constructor(x,y) { this.x = x; this.y = y; }
  update() { this.y -= 8; }
  display() { image(bulletImg,this.x-10,this.y-10,20,20); }
}

// ===== INPUT =====
function keyPressed() {
  if (keyCode === LEFT_ARROW) p.moveLeft();
  if (keyCode === RIGHT_ARROW) p.moveRight();

  if (key === " " && ammo > 0 && !reloading && !gameOver) {
    bullets.push(new Bullet(p.x,p.y));
    shootMode = true;
    ammo--;
    gunshot.play();
  }

  if ((key === "r" || key === "R") && ammo < maxAmmo) {
    reloading = true;
    reloadStart = millis();
    reload.play();
  }

  if (!gameStarted && keyCode === ENTER) gameStarted = true;

  if (gameOver && (key==="r"||key==="R")) restartGame();
}

function keyReleased() {
  if (key === " ") shootMode = false;
}

function restartGame() {
  zombies = [];
  bullets = [];
  score = 0;
  pHealth = 3;
  ammo = maxAmmo;
  reloading = false;
  gameOver = false;
  gameOverSoundPlayed = false;
  music.loop();
}
</script>

</body>
</html>

