<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>End of the World</title>

  <!-- p5.js + p5.sound -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>

  <style>
    body { margin: 0; display:flex; justify-content:center; }
    canvas { border:2px solid white; margin-top:20px; }
  </style>
</head>
<body>

<script>
// ------- GAME VARIABLES ------- //
let p;
let zombies = [];
let bullets = [];

let playerImg, shootImg, bulletImg;
let zombieImg, bigZombieImg, fastZombieImg;

let shootMode = false;
let ammo = 6;
let maxAmmo = 6;
let reloading = false;
let reloadTime = 1000;
let reloadStart;

let flash = false;
let flashTimer = 0;
let flashDuration = 30;

let spawnRate = 120;
let fastestSpawnRate = 60;
let nextScoreMilestone = 4000;

let score = 0;
let font;

let gameStarted = false;

let pHealth = 3;
let gameOver = false;
let gameOverSoundPlayed = false;

// audio
let music, gunshot, reloadSound, overSound;

// ------- SETUP ------- //
function preload() {
  music = loadSound("gameMusic.mp3");
  gunshot = loadSound("shotgunSound.wav");
  reloadSound = loadSound("reloadSound.wav");
  overSound = loadSound("over.wav");

  playerImg = loadImage("player.png");
  shootImg = loadImage("shoot.png");
  bulletImg = loadImage("bullet.png");

  zombieImg = loadImage("zombie.png");
  bigZombieImg = loadImage("big.png");
  fastZombieImg = loadImage("fast.png");
}

function setup() {
  createCanvas(550, 450);

  music.loop();
  p = new Player();
  font = createFont("orbitronRegular.ttf", 18);
  textFont(font);
}

// ------- DRAW LOOP ------- //
function draw() {
  background(0);

  if (!gameStarted) { startScreen(); return; }

  fill(255);
  textAlign(LEFT, TOP);
  text("Score: " + score, 5, 5);
  text("Ammo: " + ammo + (reloading ? " (Reloading...)" : ""), 5, 420);
  text("Health: " + pHealth, 5, 25);

  if (gameOver) {
    if (music.isPlaying()) music.pause();
    if (!gameOverSoundPlayed){
      overSound.play();
      gameOverSoundPlayed = true;
    }
    gameOverScreen();
    return;
  }

  // Reload
  if (reloading && millis() - reloadStart >= reloadTime) {
    ammo = maxAmmo;
    reloading = false;
  }

  if (ammo == 0){
    fill("red");
    textAlign(CENTER);
    text("Press R to Reload", width/2, height/2);
  }

  if (flash){
    flashTimer++;
    strokeWeight(30);
    stroke(255,0,0,200);
    noFill();
    rect(width/2,height/2,width,height);
    if (flashTimer >= flashDuration){
      flashTimer = 0;
      flash = false;
    }
  }

  if (frameCount % spawnRate === 0){
    zombies.push(new Zombie());
    if (score >= nextScoreMilestone){
      spawnRate = max(fastestSpawnRate, spawnRate - 30);
      nextScoreMilestone += 4000;
    }
  }

  // Zombies update
  for (let i = zombies.length-1; i >= 0; i--){
    let z = zombies[i];
    z.update();
    z.display();

    if (z.dead){
      score += z.points;
      zombies.splice(i,1);
    } else if(z.y > height){
      zombies.splice(i,1);
      pHealth--;
      flash = true;
      if (pHealth <= 0) gameOver = true;
    }
  }

  p.display();

  // Bullets
  for (let i=bullets.length-1;i>=0;i--){
    bullets[i].update();
    bullets[i].display();

    if (bullets[i].y < 0) bullets.splice(i,1);
  }

  // Bullet collision
  for (let i = bullets.length-1; i >= 0; i--){
    let b = bullets[i];
    let hit = false;
    for (let j = zombies.length-1; j >= 0; j--){
      let z = zombies[j];
      if (abs(b.x - z.x) < 30 && abs(b.y - z.y) < 30){
        z.hit();
        hit = true;
        if (z.dead){
          score += z.points;
          zombies.splice(j,1);
        }
        break;
      }
    }
    if (hit) bullets.splice(i,1);
  }
}

// ------- SCREENS ------- //
function startScreen(){
  fill("red");
  textAlign(CENTER);
  textSize(40);
  text("END OF THE WORLD", width/2, height/2 - 80);
  textSize(15);
  fill(255);
  text("← → Move | SPACE Shoot | R Reload", width/2, height/2 + 70);
  textSize(20);
  text("Press ENTER to Start", width/2, height/2 + 120);
}

function gameOverScreen(){
  textAlign(CENTER);
  textSize(40);
  fill("red");
  text("GAME OVER", width/2, height/2 - 30);
  textSize(20);
  fill(255);
  text("Press R to Restart", width/2, height/2 + 30);
}

// ------- KEYBOARD ------- //
function keyPressed(){
  if (keyCode === LEFT_ARROW) p.move(-1);
  if (keyCode === RIGHT_ARROW) p.move(1);

  if (key === ' ' && ammo > 0 && !reloading){
    bullets.push(new Bullet(p.x, p.y));
    ammo--;
    gunshot.play();
  }

  if ((key==='r' || key==='R')){
    if (gameOver) restartGame();
    else if (!reloading && ammo < maxAmmo){
      reloading = true;
      reloadStart = millis();
      reloadSound.play();
    }
  }

  if (!gameStarted && keyCode === ENTER){
    gameStarted = true;
  }
}

function keyReleased(){
  if (key === ' ') shootMode = false;
}

// ------- RESTART ------- //
function restartGame(){
  zombies = [];
  bullets = [];
  score = 0;
  pHealth = 3;
  ammo = maxAmmo;
  gameOver = false;
  gameOverSoundPlayed = false;
  music.loop();
}

// ------Player Class--------
class Player {
  constructor() {
    this.y = 420;
    this.slotWidth = width / 5;
    this.currentSlot = 2;
    this.health = 3;
    this.isHit = false;
  }

  get x() {
    return this.currentSlot * this.slotWidth + this.slotWidth / 2;
  }

  display() {
    let px = this.x;
    imageMode(CENTER);

    if (shootMode) {
      image(shootImg, px, this.y, 360, 280);
    } else {
      image(playerImg, px, this.y, 340, 260);
    }
  }

  takeDamage() {
    this.health--;
    this.isHit = true;
  }

  moveLeft() {
    if (this.currentSlot > 0) this.currentSlot--;
  }

  moveRight() {
    if (this.currentSlot < 4) this.currentSlot++;
  }
}

// ------Zombie Class--------
class Zombie {
  constructor() {
    this.y = 0;
    this.slotWidth = width / 5;
    this.slot = floor(random(0, 5)); 

    // Determine type
    let r = floor(random(100));

    if (r < 50) { 
      this.type = "normal";
      this.img = zombieImg; 
      this.health = 3; 
      this.speed = 1.2;
      this.points = 100;

    } else if (r < 65) { 
      this.type = "big";
      this.img = bigZombieImg; 
      this.health = 6; 
      this.speed = 1;
      this.points = 200;

    } else { 
      this.type = "fast";
      this.img = fastZombieImg; 
      this.health = 1; 
      this.speed = 2;
      this.points = 150;
    }

    this.isHit = false;
    this.hitTimer = 0;
  }

  update() {
    this.y += this.speed;

    // Glow fade timer
    if (this.isHit && millis() - this.hitTimer > 90) {
      this.isHit = false;
    }

    // Hit floor flash
    if (this.y >= height - 5 && this.y < height + 10) {
      flash = true;
    }
  }

  display() {
    let x = this.slot * this.slotWidth + this.slotWidth / 2;

    imageMode(CENTER);

    if (this.isHit) {
      tint(255, 0, 0, 255);
    } else {
      noTint();
    }

    image(this.img, x, this.y);

    noTint();
  }

  hit() {
    this.health--;
    this.isHit = true;
    this.hitTimer = millis();
    if (this.health <= 0) {
      this.dead = true;
    }
  }

  getX() {
    return this.slot * this.slotWidth + this.slotWidth / 2;
  }
}

class Bullet {
  constructor(startX, startY) {
    this.x = startX;
    this.y = startY;
    this.speed = 9;
  }

  update() {
    this.y -= this.speed;
  }

  display() {
    push();
    imageMode(CENTER);
    if (bulletImg) {
      image(bulletImg, this.x, this.y, 115, 115);
    }
  }
}
</script>
</body>
</html>
