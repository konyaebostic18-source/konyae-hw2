<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>End of the World</title>

  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
</head>
<body style="margin:0; background:black;">

<script>
// =======================
// GAME VARIABLES
// =======================
let p;
let zombies = [];
let bullets = [];

let playerImg, shootImg, bulletImg;
let zombieImg, bigZombieImg, fastZombieImg;

let music, gunshot, reloadSFX, over;

let ammo = 6;
let maxAmmo = 6;
let reloading = false;
let reloadStart = 0;
let reloadTime = 1000;

let shootMode = false;
let flash = false;
let flashTimer = 0;
let flashDuration = 30;

let spawnRate = 120;
let fastestSpawnRate = 60;
let nextScoreMilestone = 4000;

let score = 0;
let pHealth = 3;
let gameOver = false;
let gameOverSoundPlayed = false;
let gameStarted = false;

function preload() {
  playerImg = loadImage("player.png");
  shootImg = loadImage("shoot.png");
  bulletImg = loadImage("bullet.png");
  zombieImg = loadImage("zombie.png");
  bigZombieImg = loadImage("big.png");
  fastZombieImg = loadImage("fast.png");

  soundFormats('mp3','wav');
  music = loadSound("gameMusic.mp3");
  gunshot = loadSound("shotgunSound.wav");
  reloadSFX = loadSound("reloadSound.wav");
  over = loadSound("over.wav");
}

function setup() {
  createCanvas(550,450);
  p = new Player();
  music.loop();
}

function draw() {
  background(0);

  if (!gameStarted) return startScreen();
  if (gameOver) return gameOverScreen();

  drawHUD();
  handleReload();
  flashEffect();
  spawnZombies();
  updateZombies();
  p.display();
  updateBullets();
  handleBulletZombieCollision();
}

// =======================
// SCREENS
// =======================
function startScreen() {
  fill(255,0,0);
  textAlign(CENTER,CENTER);
  textSize(40);
  text("END OF THE WORLD", width/2, height/2-80);

  fill(255);
  textSize(20);
  text("Controls:", width/2, height/2-20);
  textSize(15);
  text("←/→ Move", width/2, height/2+10);
  text("SPACE Shoot", width/2, height/2+40);
  text("R Reload", width/2, height/2+70);
  textSize(20);
  text("Press ENTER to Start", width/2, height/2+130);
}

function gameOverScreen() {
  if (music.isPlaying()) music.pause();
  if (!gameOverSoundPlayed) {
    over.play();
    gameOverSoundPlayed = true;
  }

  textAlign(CENTER,CENTER);
  textSize(40);
  fill(255,0,0);
  text("GAME OVER", width/2, height/2-20);
  textSize(20);
  fill(255);
  text("Press R to Restart", width/2, height/2+30);
}

// =======================
// HUD / UI
// =======================
function drawHUD() {
  fill(255);
  textAlign(LEFT,TOP);
  text("Score: " + score, 5, 5);
  text("Ammo: " + ammo + (reloading ? " (Reloading...)" : ""), 5, 420);
  text("Health: " + pHealth, 5, 25);
}

function flashEffect() {
  if (!flash) return;
  flashTimer++;
  strokeWeight(30);
  stroke(255,0,0,200);
  noFill();
  rect(width/2, height/2, width, height);

  if (flashTimer >= flashDuration) {
    flash = false;
    flashTimer = 0;
  }
}

// =======================
// GAME LOGIC
// =======================
function handleReload() {
  if (reloading && millis() - reloadStart >= reloadTime) {
    ammo = maxAmmo;
    reloading = false;
  }

  if (ammo === 0) {
    textAlign(CENTER,CENTER);
    fill(255,0,0);
    text("R to Reload", width/2, height/2);
  }
}

function spawnZombies() {
  if (frameCount % spawnRate !== 0) return;

  zombies.push(new Zombie());

  if (score >= nextScoreMilestone) {
    spawnRate = max(fastestSpawnRate, spawnRate - 30);
    nextScoreMilestone += 4000;
  }
}

function updateZombies() {
  for (let i = zombies.length-1; i >= 0; i--) {
    let z = zombies[i];
    z.update();
    z.display();
    
    if (z.isDead()) {
      score += z.type === "big" ? 200 : z.type === "fast" ? 150 : 100;
      zombies.splice(i,1);
    } else if (z.y > height) {
      zombies.splice(i,1);
      flash = true;
      pHealth--;
      if (pHealth <= 0) gameOver = true;
    }
  }
}

function updateBullets() {
  for (let i = bullets.length-1; i >= 0; i--) {
    bullets[i].update();
    bullets[i].display();
    if (bullets[i].y < 0) bullets.splice(i,1);
  }
}

function handleBulletZombieCollision() {
  for (let i = bullets.length-1; i >= 0; i--) {
    let b = bullets[i];
    let hit = false;

    for (let j = zombies.length-1; j >= 0; j--) {
      let z = zombies[j];
      if (abs(b.x - z.getX()) < 30 && abs(b.y - z.y) < 30) {
        z.takeDamage();
        hit = true;
        if (z.isDead()) {
          score += z.type === "big" ? 200 : z.type === "fast" ? 150 : 100;
          zombies.splice(j,1);
        }
        break;
      }
    }
    if (hit) bullets.splice(i,1);
  }
}

// =======================
// INPUT
// =======================
function keyPressed() {
  if (keyCode === LEFT_ARROW) p.moveLeft();
  if (keyCode === RIGHT_ARROW) p.moveRight();

  if ((key === " " || keyCode === 32) && ammo > 0 && !reloading) {
    bullets.push(new Bullet(p.x, p.y));
    shootMode = true;
    ammo--;
    gunshot.play();
  }

  if (key === "r" || key === "R") {
    if (gameOver) return restart();
    if (!reloading && ammo < maxAmmo) {
      reloading = true;
      reloadStart = millis();
      reloadSFX.play();
    }
  }

  if (!gameStarted && keyCode === ENTER) gameStarted = true;
}

function keyReleased() {
  if (key === " ") shootMode = false;
}

// =======================
// CLASSES
// =======================

// PLAYER
class Player {
  constructor() {
    this.x = width/2;
    this.y = height-60;
  }
  display() {
    imageMode(CENTER);
    image(shootMode ? shootImg : playerImg, this.x, this.y, 80, 80);
  }
  moveLeft() { this.x = max(40, this.x - 15); }
  moveRight(){ this.x = min(width-40, this.x + 15); }
}

// BULLET
class Bullet {
  constructor(x,y) {
    this.x = x;
    this.y = y;
    this.speed = 9;
  }
  update() { this.y -= this.speed; }
  display() {
    imageMode(CENTER);
    image(bulletImg, this.x, this.y, 115, 115);
  }
}

// ZOMBIE
class Zombie {
  constructor() {
    this.y = 0;
    this.slotWidth = width/5;
    this.slot = int(random(0,5));

    let r = int(random(100));
    if (r < 50) { this.type="normal"; this.img=zombieImg; this.health=3; this.speed=1.2; }
    else if (r < 65) { this.type="big"; this.img=bigZombieImg; this.health=6; this.speed=1; }
    else { this.type="fast"; this.img=fastZombieImg; this.health=1; this.speed=2; }

    this.isHit=false;
    this.hitTimer=0;
  }

  update() {
    this.y += this.speed;
    if (this.isHit && millis() - this.hitTimer > 90) this.isHit=false;
    if (this.y >=450 && this.y<460) flash=true;
  }

  display() {
    let x = this.slot * this.slotWidth + this.slotWidth/2;
    imageMode(CENTER);
    if (this.isHit) tint(255,0,0,255);
    image(this.img, x, this.y);
    noTint();
  }

  takeDamage() {
    this.health--;
    this.isHit = true;
    this.hitTimer = millis();
  }

  isDead() { return this.health <= 0; }
  getX() { return this.slot * this.slotWidth + this.slotWidth/2; }
}

// =======================
// RESTART
// =======================
function restart() {
  zombies = [];
  bullets = [];
  score = 0;
  pHealth = 3;
  ammo = maxAmmo;
  reloading = false;
  gameOver = false;
  gameOverSoundPlayed = false;
  music.loop();
}
</script>
</body>
</html>
