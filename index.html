<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>End of the World</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>

  <style>
    body { margin: 0; display:flex; justify-content:center; background:black; }
    canvas { border:2px solid white; margin-top:20px; }
  </style>
</head>
<body>

<script>
//----------------- ASSETS -----------------//
let playerImg, shootImg, bulletImg;
let zombieImg, bigZombieImg, fastZombieImg;
let font;

//----------------- SOUNDS -----------------//
let music, gunshot, reloadSound, overSound;

//----------------- GAME VARIABLES -----------------//
let p;
let zombies = [];
let bullets = [];

let ammo = 6, maxAmmo = 6, reloading = false;
let reloadTime = 1000, reloadStart;

let score = 0, pHealth = 3;
let spawnRate = 120, fastestSpawnRate = 60, nextScoreMilestone = 4000;

let flash = false, flashTimer = 0, flashDuration = 30;
let gameStarted = false, gameOver = false, gameOverSoundPlayed = false;
let shootMode = false;


function preload() {
  font = loadFont("orbitronRegular.ttf");

  playerImg = loadImage("player.png");
  shootImg = loadImage("shoot.png");
  bulletImg = loadImage("bullet.png");

  zombieImg = loadImage("zombie.png");
  bigZombieImg = loadImage("big.png");
  fastZombieImg = loadImage("fast.png");

  music = loadSound("gameMusic.mp3");
  gunshot = loadSound("shotgunSound.wav");
  reloadSound = loadSound("reloadSound.wav");
  overSound = loadSound("over.wav");
}

//----------------- SETUP -----------------//
function setup() {
  createCanvas(550, 450);

  zombieImg.resize(260,180);
  bigZombieImg.resize(280,200);
  fastZombieImg.resize(180,100);

  textFont(font);
  textSize(18);

  music.loop();
  p = new Player();
}

//----------------- DRAW -----------------//
function draw() {
  background(0);

  if (!gameStarted) { startScreen(); return; }

   // screen flash
  if (flash) {
    flashTimer++;
    strokeWeight(30);
    stroke(255, 0, 0, 200);
    noFill();
    rect(0, 0, width, height);
    if (flashTimer >= flashDuration) { flash = false; flashTimer = 0; }
  }

  if (gameOver) {
    if (music.isPlaying()) 
      music.pause();
  }
    if (!gameOverSoundPlayed) { 
      overSound.play(); gameOverSoundPlayed = true; }
    return gameOverScreen();
  }

  // reload
  if (reloading && millis() - reloadStart >= reloadTime) {
    ammo = maxAmmo;
    reloading = false;
  }
  // spawn zombies
  if (frameCount % spawnRate === 0) {
    zombies.push(new Zombie());
    if (score >= nextScoreMilestone) {
      spawnRate = max(fastestSpawnRate, spawnRate - 30);
      nextScoreMilestone += 4000;
    }
  }


  // update zombies
  for (let i = zombies.length - 1; i >= 0; i--) {
    zombies[i].update();
    zombies[i].display();

    if (zombies[i].dead) {
      score += zombies[i].points;
      zombies.splice(i, 1);
    } else if (zombies[i].y > height) {
      zombies.splice(i, 1);
      pHealth--;
      flash = true;
      if (pHealth <= 0) gameOver = true;
    }
  }

  // player draw
  p.display();

  // bullets
  for (let i = bullets.length - 1; i >= 0; i--) {
    bullets[i].update();
    bullets[i].display();
    if (bullets[i].y < 0) bullets.splice(i, 1);
  }

  // bullet / zombie collision
  for (let i = bullets.length - 1; i >= 0; i--) {
    for (let j = zombies.length - 1; j >= 0; j--) {
      if (dist(bullets[i].x, bullets[i].y, zombies[j].getX(), zombies[j].y) < 30) {
        zombies[j].hit();
        bullets.splice(i, 1);
        break;
      }
    }
  }

  push();
  noStroke();
  fill(255);
  textAlign(LEFT, TOP);
  textSize(18);
  text("Score: " + score, 5, 5);
  text("Ammo: " + ammo + (reloading ? " (Reloading...)" : ""), 5, 420);
  text("Health: " + pHealth, 5, 25);
  pop();

  if (ammo == 0) {
    push();
    textAlign(CENTER);
    noStroke();
    fill("red");
    textSize(20);
    text("Press R to Reload", width / 2, height / 2);
    pop();
  }
}

//----------------- SCREENS -----------------//
function startScreen() {
  fill("red"); textAlign(CENTER); textSize(40);
  text("END OF THE WORLD", width/2, height/2 - 80);
  
  textSize(20); fill(255);
  text("CONTROLS", width/2, height/2 - 20);
  
  textSize(15); 
  text("RIGHT/LEFT ARROW:  Move", width / 2, height / 2 + 10);
  text("SPACE:  Shoot", width / 2, height / 2 + 40);
  text("R:  Reload", width/2, height/2 + 70);
  
  textSize(20);
  text("Press ENTER to Start", width/2, height/2 + 120);
}

function gameOverScreen() {
  push();
  textAlign(CENTER);
  fill("red"); textSize(40);
  noStroke();
  text("GAME OVER", width/2, height/2 - 30);
  textSize(20); fill(255); noStroke();
  text("Press R to Restart", width/2, height/2 + 30);
}

//----------------- KEYBOARD -----------------//
function keyPressed() {
  if (keyCode === LEFT_ARROW) p.move(-1);
  if (keyCode === RIGHT_ARROW) p.move(1);

  if (key === ' ' && ammo > 0 && !reloading) {
    bullets.push(new Bullet(p.x, p.y));
    shootMode = true
    ammo--;
    gunshot.play();
  }

  if (key === 'r' || key === 'R') {
    if (gameOver) restartGame();
    else if (!reloading && ammo < maxAmmo) {
      reloading = true;
      reloadStart = millis();
      reloadSound.play();
    }
  }

  if (!gameStarted && keyCode === ENTER) gameStarted = true;
}

function keyReleased() { if (key === ' ') shootMode = false; }

//----------------- RESTART -----------------//
function restartGame() {
  zombies = [];
  bullets = [];
  score = 0;
  pHealth = 3;
  ammo = maxAmmo;
  gameOver = false;
  gameOverSoundPlayed = false;
  spawnRate = 120;           
  nextScoreMilestone = 4000; 
  if (!music.isPlaying()) {
    music.loop();
  }
}

//----------------- CLASSES -----------------//
class Player {
  constructor() {
    this.y = 420;
    this.slotWidth = width / 5;
    this.currentSlot = 2;
  }
  get x() { return this.currentSlot * this.slotWidth + this.slotWidth / 2; }
  display() {
    imageMode(CENTER);
    let img = shootMode ? shootImg : playerImg;
    image(img, this.x, this.y, 350, 250);
  }
  move(dir) { this.currentSlot = constrain(this.currentSlot + dir, 0, 4); }
}

class Zombie {
  constructor() {
    this.y = 0;
    this.slotWidth = width / 5;
    this.slot = floor(random(0, 5));
    this.dead = false;

    let r = floor(random(100));
    if (r < 50) this.setupType("normal", zombieImg, 3, 1.2, 100);
    else if (r < 65) this.setupType("big", bigZombieImg, 6, 1, 200);
    else this.setupType("fast", fastZombieImg, 1, 2, 150);
    
    // HIT FLASH DATA 
    this.isHit = false;
    this.hitTimer = 0;
    this.hitFlashTime = 120; 
  }

  setupType(type, img, hp, spd, pts) {
    this.type = type;
    this.img = img;
    this.health = hp;
    this.speed = spd;
    this.points = pts;
  }

  update() { 
    this.y += this.speed; 
    if (this.isHit && millis() - this.hitTimer > this.hitFlashTime) {
      this.isHit = false;
    }
  }
  
  display() { 
    push();
    imageMode(CENTER); 
    if (this.isHit) {
      tint(255, 0, 0);
    } else {
      noTint();
    }
    
    image(this.img, this.getX(), this.y); 
      pop();
  }
    hit() {
      this.health--;
      this.isHit = true;
      this.hitTimer = millis();

    if (this.health <= 0) this.dead = true;
  }

  getX() {
    return this.slot * this.slotWidth + this.slotWidth / 2;
  }
}


class Bullet {
  constructor(x, y) { this.x = x; this.y = y; this.speed = 9; }
  update() { this.y -= this.speed; }
  display() { imageMode(CENTER); image(bulletImg, this.x, this.y, 115, 115); }
}
</script>
</body>
</html>




